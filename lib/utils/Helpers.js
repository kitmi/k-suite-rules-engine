"use strict";

require("source-map-support/register");

const {
  Promise
} = require('rk-utils');

function validateAction(action) {
  if (Array.isArray(action)) {
    action.forEach(r => validateAction(r));
    return;
  }

  if (typeof action !== 'function') {
    throw new Error('Invalid action(s): ' + JSON.stringify(action));
  }
}

function composeActions(actions) {
  return function (facts, next) {
    let index = -1;
    return dispatch(0);

    function dispatch(i) {
      if (i <= index) return Promise.reject(new Error('next() called multiple times'));
      index = i;
      let fn = i === actions.length ? next : actions[i];
      if (!fn) return Promise.resolve();

      try {
        return Promise.resolve(fn(facts, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err);
      }
    }
  };
}

exports.validateAction = validateAction;
exports.composeActions = composeActions;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy9IZWxwZXJzLmpzIl0sIm5hbWVzIjpbIlByb21pc2UiLCJyZXF1aXJlIiwidmFsaWRhdGVBY3Rpb24iLCJhY3Rpb24iLCJBcnJheSIsImlzQXJyYXkiLCJmb3JFYWNoIiwiciIsIkVycm9yIiwiSlNPTiIsInN0cmluZ2lmeSIsImNvbXBvc2VBY3Rpb25zIiwiYWN0aW9ucyIsImZhY3RzIiwibmV4dCIsImluZGV4IiwiZGlzcGF0Y2giLCJpIiwicmVqZWN0IiwiZm4iLCJsZW5ndGgiLCJyZXNvbHZlIiwiYmluZCIsImVyciIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNO0FBQUVBLEVBQUFBO0FBQUYsSUFBY0MsT0FBTyxDQUFDLFVBQUQsQ0FBM0I7O0FBRUEsU0FBU0MsY0FBVCxDQUF3QkMsTUFBeEIsRUFBZ0M7QUFDL0IsTUFBSUMsS0FBSyxDQUFDQyxPQUFOLENBQWNGLE1BQWQsQ0FBSixFQUEyQjtBQUMxQkEsSUFBQUEsTUFBTSxDQUFDRyxPQUFQLENBQWVDLENBQUMsSUFBSUwsY0FBYyxDQUFDSyxDQUFELENBQWxDO0FBQ0E7QUFDQTs7QUFFRCxNQUFJLE9BQU9KLE1BQVAsS0FBa0IsVUFBdEIsRUFBa0M7QUFDakMsVUFBTSxJQUFJSyxLQUFKLENBQVUsd0JBQXdCQyxJQUFJLENBQUNDLFNBQUwsQ0FBZVAsTUFBZixDQUFsQyxDQUFOO0FBQ0E7QUFDRDs7QUFFRCxTQUFTUSxjQUFULENBQXdCQyxPQUF4QixFQUFpQztBQUNoQyxTQUFPLFVBQVVDLEtBQVYsRUFBaUJDLElBQWpCLEVBQXVCO0FBQzdCLFFBQUlDLEtBQUssR0FBRyxDQUFDLENBQWI7QUFDQSxXQUFPQyxRQUFRLENBQUMsQ0FBRCxDQUFmOztBQUVBLGFBQVNBLFFBQVQsQ0FBa0JDLENBQWxCLEVBQXFCO0FBQ3BCLFVBQUlBLENBQUMsSUFBSUYsS0FBVCxFQUFnQixPQUFPZixPQUFPLENBQUNrQixNQUFSLENBQWUsSUFBSVYsS0FBSixDQUFVLDhCQUFWLENBQWYsQ0FBUDtBQUVoQk8sTUFBQUEsS0FBSyxHQUFHRSxDQUFSO0FBRUEsVUFBSUUsRUFBRSxHQUFHRixDQUFDLEtBQUtMLE9BQU8sQ0FBQ1EsTUFBZCxHQUF1Qk4sSUFBdkIsR0FBOEJGLE9BQU8sQ0FBQ0ssQ0FBRCxDQUE5QztBQUNBLFVBQUksQ0FBQ0UsRUFBTCxFQUFTLE9BQU9uQixPQUFPLENBQUNxQixPQUFSLEVBQVA7O0FBRVQsVUFBSTtBQUNILGVBQU9yQixPQUFPLENBQUNxQixPQUFSLENBQWdCRixFQUFFLENBQUNOLEtBQUQsRUFBUUcsUUFBUSxDQUFDTSxJQUFULENBQWMsSUFBZCxFQUFvQkwsQ0FBQyxHQUFHLENBQXhCLENBQVIsQ0FBbEIsQ0FBUDtBQUNBLE9BRkQsQ0FFRSxPQUFPTSxHQUFQLEVBQVk7QUFDYixlQUFPdkIsT0FBTyxDQUFDa0IsTUFBUixDQUFlSyxHQUFmLENBQVA7QUFDQTtBQUNEO0FBQ0QsR0FsQkQ7QUFtQkE7O0FBRURDLE9BQU8sQ0FBQ3RCLGNBQVIsR0FBeUJBLGNBQXpCO0FBQ0FzQixPQUFPLENBQUNiLGNBQVIsR0FBeUJBLGNBQXpCIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgeyBQcm9taXNlIH0gPSByZXF1aXJlKCdyay11dGlscycpO1xuXG5mdW5jdGlvbiB2YWxpZGF0ZUFjdGlvbihhY3Rpb24pIHtcblx0aWYgKEFycmF5LmlzQXJyYXkoYWN0aW9uKSkge1xuXHRcdGFjdGlvbi5mb3JFYWNoKHIgPT4gdmFsaWRhdGVBY3Rpb24ocikpO1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGlmICh0eXBlb2YgYWN0aW9uICE9PSAnZnVuY3Rpb24nKSB7XG5cdFx0dGhyb3cgbmV3IEVycm9yKCdJbnZhbGlkIGFjdGlvbihzKTogJyArIEpTT04uc3RyaW5naWZ5KGFjdGlvbikpO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGNvbXBvc2VBY3Rpb25zKGFjdGlvbnMpIHtcblx0cmV0dXJuIGZ1bmN0aW9uIChmYWN0cywgbmV4dCkge1xuXHRcdGxldCBpbmRleCA9IC0xO1xuXHRcdHJldHVybiBkaXNwYXRjaCgwKTtcblxuXHRcdGZ1bmN0aW9uIGRpc3BhdGNoKGkpIHtcblx0XHRcdGlmIChpIDw9IGluZGV4KSByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKCduZXh0KCkgY2FsbGVkIG11bHRpcGxlIHRpbWVzJykpO1xuXG5cdFx0XHRpbmRleCA9IGk7XG5cblx0XHRcdGxldCBmbiA9IGkgPT09IGFjdGlvbnMubGVuZ3RoID8gbmV4dCA6IGFjdGlvbnNbaV07XG5cdFx0XHRpZiAoIWZuKSByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKCk7XG5cblx0XHRcdHRyeSB7XG5cdFx0XHRcdHJldHVybiBQcm9taXNlLnJlc29sdmUoZm4oZmFjdHMsIGRpc3BhdGNoLmJpbmQobnVsbCwgaSArIDEpKSk7XG5cdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0cmV0dXJuIFByb21pc2UucmVqZWN0KGVycilcblx0XHRcdH1cblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0cy52YWxpZGF0ZUFjdGlvbiA9IHZhbGlkYXRlQWN0aW9uO1xuZXhwb3J0cy5jb21wb3NlQWN0aW9ucyA9IGNvbXBvc2VBY3Rpb25zOyJdfQ==